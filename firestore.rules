rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // HELPER FUNCTIONS
    // ---------------------------------------------------------

    // 1. Role Checks
    function isSuperAdmin() {
      return request.auth.token.role == 'SUPER_ADMIN';
    }

    function isManager() {
      return request.auth.token.role == 'MANAGER'; 
    }

    // 2. Tenancy Check (The Golden Rule)
    function belongsToProperty(propertyId) {
      return request.auth.token.propertyId == propertyId;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    // ---------------------------------------------------------
    // COLLECTION RULES
    // ---------------------------------------------------------

    // Root Collection: Hotels (Multi-Tenant Isolation)
    // Legacy note: Code uses 'hotels', Schema uses 'properties'. 
    // Matching 'hotels' here to align with active frontend/backend code.
    match /hotels/{propertyId} {
      
      // Property Document Access
      allow read: if isSignedIn() && (isSuperAdmin() || belongsToProperty(propertyId));
      allow write: if isSignedIn() && isSuperAdmin();

      // -------------------------------------------------------
      // SUB-COLLECTION: ROOMS
      // -------------------------------------------------------
      match /rooms/{roomId} {
         allow read: if isSignedIn() && (isSuperAdmin() || belongsToProperty(propertyId));
         // Writes are handled via Backend API -> Firestore Admin SDK
      }

      // -------------------------------------------------------
      // SUB-COLLECTION: TIME CLOCKS
      // -------------------------------------------------------
      match /time_clocks/{clockId} {
        // READ: Managers can read all. Staff can read their own.
        allow read: if isSignedIn() && (
          isSuperAdmin() || 
          (belongsToProperty(propertyId) && (isManager() || resource.data.userId == request.auth.uid))
        );

        // CREATE: Staff can only create for themselves.
        allow create: if isSignedIn() && (
          isSuperAdmin() || 
          (belongsToProperty(propertyId) && (
            isManager() || 
            request.resource.data.userId == request.auth.uid
          ))
        );

        // UPDATE: Users can clock out (update their own doc). Managers can edit any.
        allow update: if isSignedIn() && (
          isSuperAdmin() || 
          (belongsToProperty(propertyId) && (
            isManager() || 
            (resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid)
          ))
        );
      }

      // -------------------------------------------------------
      // SUB-COLLECTION: MAINTENANCE EVENTS (Real-time triggers)
      // -------------------------------------------------------
      match /maintenance_events/{eventId} {
        allow read: if isSignedIn() && (isSuperAdmin() || belongsToProperty(propertyId));
      }

      // -------------------------------------------------------
      // SUB-COLLECTION: MAINTENANCE TICKETS (Legacy/Direct)
      // -------------------------------------------------------
      match /maintenance_tickets/{ticketId} {
        // READ: Anyone in the property can view tickets
        allow read: if isSignedIn() && (isSuperAdmin() || belongsToProperty(propertyId));

        // CREATE: Anyone in the property can report an issue
        allow create: if isSignedIn() && (isSuperAdmin() || belongsToProperty(propertyId));

        // UPDATE: Managers can do anything. Staff can only update if assigned or created by them.
        allow update: if isSignedIn() && (
          isSuperAdmin() || 
          (belongsToProperty(propertyId) && (
            isManager() || 
            resource.data.assignedTo == request.auth.uid || 
            resource.data.createdBy == request.auth.uid
          ))
        );
      }
    }

    // ---------------------------------------------------------
    // GLOBAL COLLECTIONS
    // ---------------------------------------------------------
    match /global/features/events/{eventId} {
       allow read: if isSignedIn();
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
